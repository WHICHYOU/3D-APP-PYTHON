name: Build Multi-Platform Installers

on:
  # Trigger on version tags
  push:
    tags:
      - "v*.*.*"

  # Allow manual workflow dispatch
  workflow_dispatch:
    inputs:
      version:
        description: "Version number (e.g., 1.0.0)"
        required: true
        default: "1.0.0"

jobs:
  build-macos:
    name: Build macOS Application
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt
          pip install -r requirements-macos.txt

      - name: Build macOS app
        run: |
          chmod +x build_config/build_macos.sh
          pyinstaller --noconfirm build_config/app.spec

      - name: Verify build
        run: |
          if [ ! -d "dist/2D-to-3D-Converter.app" ]; then
            echo "Build failed - app bundle not found"
            exit 1
          fi
          echo "Build successful"
          du -sh dist/2D-to-3D-Converter.app

      - name: Create DMG (optional)
        continue-on-error: true
        run: |
          brew install create-dmg
          create-dmg \
            --volname "2D to 3D Converter" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "2D-to-3D-Converter.app" 175 120 \
            --hide-extension "2D-to-3D-Converter.app" \
            --app-drop-link 625 120 \
            "2D-to-3D-Converter-macOS.dmg" \
            "dist/"

      - name: Zip macOS app
        run: |
          cd dist
          zip -r ../2D-to-3D-Converter-macOS.zip 2D-to-3D-Converter.app
          cd ..

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: |
            2D-to-3D-Converter-macOS.zip
            2D-to-3D-Converter-macOS.dmg
          retention-days: 30

  build-windows:
    name: Build Windows Application
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt
          pip install -r requirements-windows.txt

      - name: Build Windows exe
        run: |
          python -m PyInstaller --noconfirm build_config/app.spec

      - name: Verify build
        run: |
          if (-not (Test-Path "dist/2D-to-3D-Converter.exe")) {
            Write-Error "Build failed - executable not found"
            exit 1
          }
          Write-Output "Build successful"
          Get-Item dist/2D-to-3D-Converter.exe | Select-Object Name, Length

      - name: Zip Windows exe
        run: |
          Compress-Archive -Path dist/2D-to-3D-Converter.exe -DestinationPath 2D-to-3D-Converter-Windows.zip

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: 2D-to-3D-Converter-Windows.zip
          retention-days: 30

  build-linux:
    name: Build Linux Application
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libxcb-xinerama0 \
            libxcb-cursor0 \
            libxkbcommon-x11-0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-shape0 \
            libgl1-mesa-glx \
            ffmpeg

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu

      - name: Build Linux binary
        run: |
          pyinstaller --noconfirm build_config/app.spec

      - name: Verify build
        run: |
          if [ ! -f "dist/2D-to-3D-Converter/2D-to-3D-Converter" ]; then
            echo "Build failed - executable not found"
            exit 1
          fi
          echo "Build successful"
          ls -lh dist/2D-to-3D-Converter/

      - name: Tar Linux binary
        run: |
          cd dist
          tar -czf ../2D-to-3D-Converter-Linux.tar.gz 2D-to-3D-Converter/
          cd ..

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-binary
          path: 2D-to-3D-Converter-Linux.tar.gz
          retention-days: 30

  create-release:
    name: Create GitHub Release
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: false
          files: |
            macos-app/*
            windows-exe/*
            linux-binary/*
          body: |
            ## 2D-to-3D Video Converter ${{ github.ref_name }}

            ### Downloads

            **macOS (Apple Silicon recommended)**
            - `2D-to-3D-Converter-macOS.dmg` - Installer (recommended)
            - `2D-to-3D-Converter-macOS.zip` - Portable app bundle

            **Windows (NVIDIA GPU recommended)**
            - `2D-to-3D-Converter-Windows.zip` - Includes CUDA support

            **Linux**
            - `2D-to-3D-Converter-Linux.tar.gz` - CPU-only version

            ### System Requirements

            **macOS:**
            - macOS 11.0 (Big Sur) or later
            - Apple Silicon (M1/M2/M3) recommended for MPS acceleration
            - 8GB RAM minimum, 16GB recommended

            **Windows:**
            - Windows 10/11 (64-bit)
            - NVIDIA GPU with CUDA support (highly recommended)
            - 8GB RAM minimum, 16GB recommended

            **Linux:**
            - Ubuntu 20.04+ or equivalent
            - 8GB RAM minimum
            - GPU support requires manual PyTorch CUDA installation

            ### First Run

            The application will download the MiDaS depth estimation model (~1.3 GB) on first run.
            Ensure you have a stable internet connection.

            ### Performance

            With GPU acceleration:
            - Apple Silicon (MPS): ~1.5-3s per frame
            - NVIDIA GPU (CUDA): ~1.5-3s per frame

            CPU-only (slow):
            - ~10-20s per frame

            ### Issues?

            Report bugs at: https://github.com/${{ github.repository }}/issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
